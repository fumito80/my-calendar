(()=>{"use strict";const e=864e5;function t(e){return document.getElementsByClassName(e)[0]}function n(e){return 864e5*Math.trunc((Number(e)-54e6)/864e5)+54e6}function a(){const t=new Date(n((new Date).setDate(1)));return new Date(Number(t)-((t.getDay()+1)%7+7)*e)}function s(s){t("year").textContent=`${String((new Date).getFullYear())}（令和${String((new Date).getFullYear()-2018)}年）`;const i=s.sort(((e,t)=>e.dateNum-t.dateNum)),c=t("grid");c.innerHTML="";const o=Number(a()),{dates:r}=[...Array(105)].reduce(((t,n,a)=>{const s=new Date(o+e*a),[i,c]=function(e,t){const n=[];for(let a=0;a<e.length;a+=1)if(e[a].dateNum===t)n.push(e[a]);else if(e[a].dateNum>t)break;return[n,e.slice(n.length)]}(t.myEvents,Number(s));return{myEvents:c,dates:[...t.dates,{date:s,events:i}]}}),{myEvents:i,dates:[]});c.append(...["土","日","月","火","水","木","金"].map((e=>Object.assign(document.createElement("div"),{title:e}))),...r.map(function(e){const t=new Date(e).getMonth();return({date:n,events:a},s)=>{const i=s&&1!==n.getDate()?n.getDate():n.toLocaleDateString().substring(5),c=Object.assign(document.createElement("div"),{title:i});Number(n)===e&&c.classList.add("today"),s%7<2&&c.classList.add("holiday");const o=Math.abs(n.getMonth()-t);return c.classList.add(`month-${o}`),c.append(...a.map((({summary:e,eventType:t})=>Object.assign(document.createElement("div"),{title:e,className:t})))),c}}(n(Date.now()))))}const i=["https://apis.google.com/js/api.js","https://accounts.google.com/gsi/client"],c=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],o=["https://www.googleapis.com/auth/calendar.readonly"],r={21:"event",12:"anniversary",15:"owner"};async function l(){const{result:e}=await gapi.client.calendar.calendarList.list();return e.items.map((({id:e,colorId:t})=>({id:e,eventType:r[t]})))}async function d([e,...t],s=[]){if(!e)return s;const i=await async function(e){return(await gapi.client.calendar.events.list({calendarId:e.id,timeMin:a().toISOString(),showDeleted:!1,singleEvents:!0,maxResults:30,orderBy:"startTime"})).result.items.map((t=>({eventType:"祝日"===t.description&&"event"===e.eventType?"holiday":e.eventType,dateNum:n(new Date(t.start.date)),summary:t.summary})))}(e);return d(t,[...s,...i])}function u(){const e=t("api-key")?.value,n=t("client-id")?.value;return e&&n?Promise.resolve({apiKey:e,clientId:n}):Promise.reject()}async function m(e){return gapi.client.init({apiKey:e.apiKey,discoveryDocs:c})}function p(e,t,n){return({error:a})=>{void 0!==a&&n(a),localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("clientId",e.clientId),t(e)}}async function g(){return new Promise((e=>{gapi.load("client",e)}))}async function y(e){const t="undefined"!=typeof gapi?gapi.client?.getToken():void 0;if(t&&await async function(e){return!!(await fetch(`https://oauth2.googleapis.com/tokeninfo?access_token=${e}`).then((e=>e.json()))).azp}(t.access_token))return l().then(d).then(s).catch(console.error);const n=e.map((e=>new Promise((t=>{const n=document.head.appendChild(document.createElement("script"));n.src=e,n.addEventListener("load",t)}))));return Promise.all(n).then(g).then(u).then((async e=>new Promise(((t,n)=>{google.accounts.oauth2.initTokenClient({scope:o.join(" "),client_id:e.clientId,callback:p(e,t,n)}).requestAccessToken({prompt:""})})))).then(m).then(l).then(d).then(s).catch(console.error)}t("api-key").value=localStorage.getItem("apiKey")||"",t("client-id").value=localStorage.getItem("clientId")||"",y(i),t("form-config")?.addEventListener("submit",(e=>{y(i),e.preventDefault()})),t("config")?.addEventListener("click",(()=>{const e=t("main"),n=e.classList.contains("hide-config")?"remove":"add";e.classList[n]("hide-config")}))})();