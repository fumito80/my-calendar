(()=>{"use strict";const e=864e5,t=54e6,n=["土","日","月","火","水","木","金"];function a(e){return document.getElementsByClassName(e)[0]}const i=function(n=new Date){return new Date(Math.trunc((Number(n)-t)/e)*e+t)}();function r(){const t=new Date(new Date(i).setDate(1));return new Date(Number(t)-((t.getDay()+1)%7+7)*e)}function s({date:e,events:t},n){const a=n&&1!==e.getDate()?e.getDate():e.toLocaleDateString().substring(5),r=e.toLocaleDateString(),s=Object.assign(document.createElement("div"),{textContent:a,title:r});Number(e)===Number(i)&&s.classList.add("today"),n%7<2&&s.classList.add("holiday");const o=e.getMonth()-i.getMonth();return s.classList.add(`month-${o}`),s.append(...t.map((({summary:e,eventType:t})=>Object.assign(document.createElement("div"),{title:e,className:t})))),s}function o(t){const o=t.sort(((e,t)=>e.dateNum-t.dateNum)),c=a("grid");c.innerHTML="";const l=Number(r()),{dates:d}=[...Array(105)].reduce(((t,n,a)=>{const i=new Date(l+e*a),[r,s]=function(e,t){const n=[];for(let a=0;a<e.length;a+=1)if(e[a].dateNum===t)n.push(e[a]);else if(e[a].dateNum>t)break;return[n,e.slice(n.length)]}(t.myEvents,Number(i));return{myEvents:s,dates:[...t.dates,{date:i,events:r}]}}),{myEvents:o,dates:[]});c.append(...n.map((e=>Object.assign(document.createElement("div"),{title:e}))),...d.map(s));const u=(i.getDay()+1)%7;return c.children[u].classList.add("todays-day"),t}const c=["https://apis.google.com/js/api.js","https://accounts.google.com/gsi/client"],l=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],d=["https://www.googleapis.com/auth/calendar.readonly"],u={21:"event",12:"anniversary",15:"owner"};async function m(){const{result:e}=await gapi.client.calendar.calendarList.list();return e.items.map((({id:e,colorId:t})=>({id:e,eventType:u[t]})))}async function g([e,...t],n=[]){if(!e)return n;const a=await async function(e){return(await gapi.client.calendar.events.list({calendarId:e.id,timeMin:r().toISOString(),showDeleted:!1,singleEvents:!0,maxResults:30,orderBy:"startTime"})).result.items.map((t=>({eventType:"祝日"===t.description&&"event"===e.eventType?"holiday":e.eventType,dateNum:Number(new Date(t.start.date.replaceAll("-","/"))),summary:t.summary})))}(e);return g(t,[...n,...a])}async function p({apiKey:e}){return gapi.client.init({apiKey:e,discoveryDocs:l})}function y(e,t,n){return({error:a})=>{void 0!==a&&n(a),localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("clientId",e.clientId),t(e)}}async function f(){return new Promise((e=>{gapi.load("client",e)}))}async function v(e=!1){const t=await function(){const e=a("api-key")?.value,t=a("client-id")?.value;return e&&t?Promise.resolve({apiKey:e,clientId:t}):Promise.reject()}().catch((()=>{}));if(!t)return;const n=function({apiKey:e}){const t=sessionStorage.getItem(e);if(t){const e=JSON.parse(t);if(n=e,Array.isArray(n)&&"number"==typeof n[0]?.dateNum&&"string"==typeof n[0]?.summary&&"string"==typeof n[0]?.eventType)return e}var n}(t);if(!e&&n)return o(n);const i="undefined"!=typeof gapi?gapi.client?.getToken():void 0;return i&&await async function(e){return!!(await fetch(`https://oauth2.googleapis.com/tokeninfo?access_token=${e}`).then((e=>e.json()))).azp}(i.access_token)?m().then(g).then(o).catch(console.error):async function(){const e=c.map((e=>new Promise((t=>{const n=document.head.appendChild(document.createElement("script"));n.src=e,n.addEventListener("load",(()=>t()))}))));return Promise.all(e)}().then(f).then(function(e){return()=>new Promise(((t,n)=>{google.accounts.oauth2.initTokenClient({scope:d.join(" "),client_id:e.clientId,callback:y(e,t,n)}).requestAccessToken({prompt:""})}))}(t)).then(p).then(m).then(g).then(o).then(function({apiKey:e}){return t=>{sessionStorage.setItem(e,JSON.stringify(t))}}(t)).catch(console.error)}const h=i.toLocaleDateString().replace("/",`年（令和${i.getFullYear()-2018}年）`).replace("/","月").concat(`日 ${n[(i.getDay()+1)%7]}曜日`);a("date").prepend(document.createTextNode(h)),a("api-key").value=localStorage.getItem("apiKey")||"",a("client-id").value=localStorage.getItem("clientId")||"",a("clear-pwa-cache").addEventListener("click",(()=>{navigator.serviceWorker.getRegistration().then((e=>e?.unregister()))})),a("form-config")?.addEventListener("submit",(e=>{v(!0),e.preventDefault()})),a("config")?.addEventListener("click",(()=>{const e=a("main"),t=e.classList.contains("hide-config")?"remove":"add";e.classList[t]("hide-config")})),a("refresh")?.addEventListener("click",(()=>{v(!0)})),v(),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js").then((e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}),(e=>{console.info("ServiceWorker registration failed: ",e)}))})();